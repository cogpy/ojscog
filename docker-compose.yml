version: '3.8'

services:
  # =============================================================================
  # Core Services
  # =============================================================================
  
  # OJS Core Application
  ojs:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ojscog-ojs
    ports:
      - "8000:80"
    volumes:
      - ./:/var/www/html
      - ojs_files:/var/www/files
      - ojs_public:/var/www/html/public
    environment:
      - OJS_DB_HOST=mysql
      - OJS_DB_USER=ojs
      - OJS_DB_PASSWORD=ojs
      - OJS_DB_NAME=ojs
      - OJS_DB_DRIVER=mysqli
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ojscog-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/index.php"]
      interval: 30s
      timeout: 10s
      retries: 3
      
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: ojscog-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=ojs
      - MYSQL_USER=ojs
      - MYSQL_PASSWORD=ojs
      - MYSQL_CHARACTER_SET_SERVER=utf8mb4
      - MYSQL_COLLATION_SERVER=utf8mb4_unicode_ci
    volumes:
      - mysql_data:/var/lib/mysql
      - ./plugins/generic/skzAgents/schema.sql:/docker-entrypoint-initdb.d/01-skz-schema.sql
      - ./dbscripts/xml:/docker-entrypoint-initdb.d/ojs-schema
    ports:
      - "3306:3306"
    networks:
      - ojscog-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5
      
  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: ojscog-redis
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - ojscog-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      
  # =============================================================================
  # Agent Services
  # =============================================================================
  
  # API Gateway (Central coordination)
  api-gateway:
    build:
      context: ./skz-integration/autonomous-agents-framework
      dockerfile: Dockerfile
    container_name: ojscog-api-gateway
    command: python src/api_gateway.py
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=development
      - FLASK_APP=src/api_gateway.py
      - OJS_DB_URL=mysql+pymysql://ojs:ojs@mysql:3306/ojs
      - REDIS_URL=redis://redis:6379/0
      - AGENT_DISCOVERY_ENABLED=true
      - LOG_LEVEL=INFO
    volumes:
      - ./skz-integration/autonomous-agents-framework:/app
      - agent_logs:/app/logs
    depends_on:
      - mysql
      - redis
    networks:
      - ojscog-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      
  # Agent 1: Research Discovery
  agent-research-discovery:
    build:
      context: ./skz-integration/autonomous-agents-framework
      dockerfile: Dockerfile
    container_name: ojscog-agent-research-discovery
    command: python src/agents/research_discovery_agent.py
    ports:
      - "5001:5001"
    environment:
      - AGENT_ID=research-discovery
      - AGENT_PORT=5001
      - API_GATEWAY_URL=http://api-gateway:5000
      - OJS_DB_URL=mysql+pymysql://ojs:ojs@mysql:3306/ojs
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
    volumes:
      - ./skz-integration/autonomous-agents-framework:/app
      - agent_data:/app/data
    depends_on:
      - api-gateway
    networks:
      - ojscog-network
    restart: unless-stopped
      
  # Agent 2: Submission Assistant
  agent-submission-assistant:
    build:
      context: ./skz-integration/autonomous-agents-framework
      dockerfile: Dockerfile
    container_name: ojscog-agent-submission-assistant
    command: python src/agents/submission_assistant_agent.py
    ports:
      - "5002:5002"
    environment:
      - AGENT_ID=submission-assistant
      - AGENT_PORT=5002
      - API_GATEWAY_URL=http://api-gateway:5000
      - OJS_DB_URL=mysql+pymysql://ojs:ojs@mysql:3306/ojs
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./skz-integration/autonomous-agents-framework:/app
      - agent_data:/app/data
    depends_on:
      - api-gateway
    networks:
      - ojscog-network
    restart: unless-stopped
      
  # Agent 3: Editorial Orchestration
  agent-editorial-orchestration:
    build:
      context: ./skz-integration/autonomous-agents-framework
      dockerfile: Dockerfile
    container_name: ojscog-agent-editorial-orchestration
    command: python src/agents/editorial_orchestration_agent.py
    ports:
      - "5003:5003"
    environment:
      - AGENT_ID=editorial-orchestration
      - AGENT_PORT=5003
      - API_GATEWAY_URL=http://api-gateway:5000
      - OJS_DB_URL=mysql+pymysql://ojs:ojs@mysql:3306/ojs
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./skz-integration/autonomous-agents-framework:/app
      - agent_data:/app/data
    depends_on:
      - api-gateway
    networks:
      - ojscog-network
    restart: unless-stopped
      
  # Agent 4: Review Coordination
  agent-review-coordination:
    build:
      context: ./skz-integration/autonomous-agents-framework
      dockerfile: Dockerfile
    container_name: ojscog-agent-review-coordination
    command: python src/agents/review_coordination_agent.py
    ports:
      - "5004:5004"
    environment:
      - AGENT_ID=review-coordination
      - AGENT_PORT=5004
      - API_GATEWAY_URL=http://api-gateway:5000
      - OJS_DB_URL=mysql+pymysql://ojs:ojs@mysql:3306/ojs
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
    volumes:
      - ./skz-integration/autonomous-agents-framework:/app
      - agent_data:/app/data
    depends_on:
      - api-gateway
    networks:
      - ojscog-network
    restart: unless-stopped
      
  # Agent 5: Content Quality
  agent-content-quality:
    build:
      context: ./skz-integration/autonomous-agents-framework
      dockerfile: Dockerfile
    container_name: ojscog-agent-content-quality
    command: python src/agents/content_quality_agent.py
    ports:
      - "5005:5005"
    environment:
      - AGENT_ID=content-quality
      - AGENT_PORT=5005
      - API_GATEWAY_URL=http://api-gateway:5000
      - OJS_DB_URL=mysql+pymysql://ojs:ojs@mysql:3306/ojs
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./skz-integration/autonomous-agents-framework:/app
      - agent_data:/app/data
    depends_on:
      - api-gateway
    networks:
      - ojscog-network
    restart: unless-stopped
      
  # Agent 6: Publishing Production
  agent-publishing-production:
    build:
      context: ./skz-integration/autonomous-agents-framework
      dockerfile: Dockerfile
    container_name: ojscog-agent-publishing-production
    command: python src/agents/publishing_production_agent.py
    ports:
      - "5006:5006"
    environment:
      - AGENT_ID=publishing-production
      - AGENT_PORT=5006
      - API_GATEWAY_URL=http://api-gateway:5000
      - OJS_DB_URL=mysql+pymysql://ojs:ojs@mysql:3306/ojs
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - ./skz-integration/autonomous-agents-framework:/app
      - agent_data:/app/data
    depends_on:
      - api-gateway
    networks:
      - ojscog-network
    restart: unless-stopped
      
  # Agent 7: Analytics & Monitoring
  agent-analytics-monitoring:
    build:
      context: ./skz-integration/autonomous-agents-framework
      dockerfile: Dockerfile
    container_name: ojscog-agent-analytics-monitoring
    command: python src/agents/analytics_monitoring_agent.py
    ports:
      - "5007:5007"
    environment:
      - AGENT_ID=analytics-monitoring
      - AGENT_PORT=5007
      - API_GATEWAY_URL=http://api-gateway:5000
      - OJS_DB_URL=mysql+pymysql://ojs:ojs@mysql:3306/ojs
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - ./skz-integration/autonomous-agents-framework:/app
      - agent_data:/app/data
    depends_on:
      - api-gateway
    networks:
      - ojscog-network
    restart: unless-stopped

# =============================================================================
# Networks
# =============================================================================

networks:
  ojscog-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# =============================================================================
# Volumes
# =============================================================================

volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  ojs_files:
    driver: local
  ojs_public:
    driver: local
  agent_logs:
    driver: local
  agent_data:
    driver: local
